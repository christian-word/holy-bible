<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Біблія — пошук та навігація</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;line-height:1.4;padding:20px;max-width:900px;margin:0 auto;color:#111}
    h1{font-size:20px;margin:0 0 12px}
    .note{color:#666;font-size:13px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    input[type="search"], select{flex:1;padding:8px 10px;font-size:15px;border:1px solid #ccc;border-radius:6px}
    button{padding:8px 10px;border-radius:6px;border:1px solid #bbb;background:#f5f5f5;cursor:pointer}
    #results, #verseDisplay{margin-top:14px}
    .res{padding:8px;border-bottom:1px solid #eee}
    .ref{font-weight:600;margin-bottom:6px}
    .text{white-space:pre-wrap}
    .small{font-size:13px;color:#666}
    mark{background:yellow;padding:0}
  </style>
</head>
<body>
  <h1>Біблія — пошук та навігація</h1>
  <div class="note">Текст завантажується через зовнішній скрипт. Можна шукати слова або обирати книгу, главу та вірш.</div>

  <!-- Підключення API -->
  <script src="https://christian-word.github.io/bible-engine/bible-API.js"></script>

  <!-- Пошук -->
  <div class="row">
    <input id="q" type="search" placeholder="Пошук по тексту..." autocomplete="off" />
    <button id="btn">Знайти</button>
  </div>
  <div id="status" class="small">Ініціалізація...</div>
  <div id="results"></div>

  <hr>

  <!-- Навігація по книгах -->
  <div class="row">
    <select id="bookSelect"><option value="">Оберіть книгу</option></select>
    <select id="chapterSelect"><option value="">Глава</option></select>
    <select id="verseSelect"><option value="">Вірш</option></select>
  </div>
  <div id="verseDisplay" class="text"></div>

  <script>
    const qEl = document.getElementById('q');
    const btn = document.getElementById('btn');
    const resultsEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const verseSelect = document.getElementById('verseSelect');
    const verseDisplay = document.getElementById('verseDisplay');

    function setStatus(t){ statusEl.textContent = t; }

    function highlight(text, query) {
      if (!query) return text;
      const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const re = new RegExp(safeQuery, 'gi');
      return text.replace(re, match => `<mark>${match}</mark>`);
    }

    async function doSearch(){
      const q = qEl.value.trim();
      resultsEl.innerHTML = '';
      if (!q) { setStatus('Введіть запит.'); return; }
      setStatus('Пошук...');
      try{
        if (!window.bible) throw new Error('Bible API не знайдено.');
        await window.bible.ready();
        const items = await window.bible.search(q);
        if (!items || !items.length){ setStatus('Нічого не знайдено.'); return; }
        setStatus(`Знайдено ${items.length} збігів`);
        const frag = document.createDocumentFragment();
        for (let it of items){
          const wrap = document.createElement('div'); wrap.className='res';
          const ref = document.createElement('div'); ref.className='ref';
          ref.textContent = `${it.book} ${it.chapter}:${it.verse}`;
          const txt = document.createElement('div'); txt.className='text';
          txt.innerHTML = highlight(it.text, q);
          wrap.appendChild(ref); wrap.appendChild(txt);
          frag.appendChild(wrap);
        }
        resultsEl.appendChild(frag);
      }catch(e){
        console.error(e);
        setStatus('Помилка: ' + (e?.message || String(e)));
      }
    }

    btn.addEventListener('click', doSearch);
    qEl.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

    async function initBooks(){
      try{
        if (!window.bible) { setStatus('Bible API не знайдено.'); return; }
        setStatus('Завантаження тексту Біблії...');
        await window.bible.ready();
        setStatus('Готово. Можна шукати або обрати книгу.');

        const books = await window.bible.getBooks();
        books.forEach((b, idx) => {
          const opt = document.createElement('option');
          opt.value = idx+1;
          opt.textContent = b;
          bookSelect.appendChild(opt);
        });
      }catch(err){
        console.error(err);
        setStatus('Не вдалося завантажити: ' + (err?.message || String(err)));
      }
    }

    bookSelect.addEventListener('change', async () => {
      chapterSelect.innerHTML = '<option value="">Глава</option>';
      verseSelect.innerHTML = '<option value="">Вірш</option>';
      verseDisplay.textContent = '';
      const bookNum = bookSelect.value;
      if (!bookNum) return;
      const chapters = await window.bible.getChapters(bookNum);
      chapters.forEach((ch, idx) => {
        const opt = document.createElement('option');
        opt.value = idx+1;
        opt.textContent = idx+1;
        chapterSelect.appendChild(opt);
      });
    });

    chapterSelect.addEventListener('change', async () => {
      verseSelect.innerHTML = '<option value="">Вірш</option>';
      verseDisplay.textContent = '';
      const bookNum = bookSelect.value;
      const chapterNum = chapterSelect.value;
      if (!bookNum || !chapterNum) return;
      const verses = await window.bible.getVerses(bookNum, chapterNum);
      verses.forEach((v, idx) => {
        const opt = document.createElement('option');
        opt.value = idx+1;
        opt.textContent = idx+1;
        verseSelect.appendChild(opt);
      });
    });

    verseSelect.addEventListener('change', async () => {
      const bookNum = bookSelect.value;
      const chapterNum = chapterSelect.value;
      const verseNum = verseSelect.value;
      if (!bookNum || !chapterNum || !verseNum) return;
      const verseText = await window.bible.getVerse(bookNum, chapterNum, verseNum);
      verseDisplay.textContent = verseText;
    });

    initBooks();
  </script>
</body>
</html>
