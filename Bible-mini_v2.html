<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë—ñ–±–ª—ñ—è ‚Äî –ø–æ—à—É–∫ —Ç–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è</title>
<style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --text-color: #333;
      --light-gray: #f5f5f5;
      --border-color: #ddd;
      --background-color: #fff;
      --card-background: #fff;
      --hover-color: #e0e0e0;
      --bookmark-color: #f39c12;
      --bookmark-active: #e67e22;
    }

    [data-theme="dark"] {
      --primary-color: #ecf0f1;
      --secondary-color: #3498db;
      --text-color: #ecf0f1;
      --light-gray: #34495e;
      --border-color: #555;
      --background-color: #2c3e50;
      --card-background: #34495e;
      --hover-color: #4a5f7a;
      --bookmark-color: #f39c12;
      --bookmark-active: #e67e22;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      padding: 10px;
      max-width: 900px;
      margin: 0 auto;
      color: var(--text-color);
      background-color: var(--background-color);
      transition: background-color 0.3s, color 0.3s;
    }
    
    h1 {
      font-size: 1.4rem;
      margin: 0 0 12px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border-color);
      background: var(--card-background);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--hover-color);
    }

    .icon-btn.active {
      background: var(--secondary-color);
      color: white;
      border-color: var(--secondary-color);
    }
    
    .note {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }
    
    .search-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .nav-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .chapter-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
    }
    
    input[type="search"] {
      flex: 1;
      min-width: 0;
      padding: 10px 12px;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-background);
      color: var(--text-color);
    }
    
    select {
      flex: 1;
      min-width: 0;
      padding: 10px 12px;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-background);
      color: var(--text-color);
    }
    
    button {
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--light-gray);
      color: var(--text-color);
      cursor: pointer;
      font-size: 1rem;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    button:hover {
      background: var(--hover-color);
    }
    
    button.primary {
      background: var(--secondary-color);
      color: white;
      border-color: var(--secondary-color);
    }
    
    button.primary:hover {
      background: #2980b9;
    }
    
    button.nav-arrow {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 18px;
    }
    
    button.nav-arrow:disabled {
      opacity: 0.3;
      cursor: default;
    }

    .bookmarks-panel {
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 15px;
      padding: 15px;
      display: none;
    }

    .bookmarks-panel.show {
      display: block;
    }

    .bookmarks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .bookmarks-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .bookmark-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }

    .bookmark-item:last-child {
      border-bottom: none;
    }

    .bookmark-item:hover {
      background: var(--hover-color);
      margin: 0 -8px;
      padding: 8px;
      border-radius: 4px;
    }

    .bookmark-ref {
      font-weight: 600;
      color: var(--secondary-color);
    }

    .bookmark-text {
      font-size: 0.9rem;
      color: var(--text-color);
      opacity: 0.8;
      margin-top: 2px;
    }

    .bookmark-delete {
      color: #e74c3c;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .bookmark-delete:hover {
      background: #fee;
    }
    
    #results, #chapterDisplay {
      margin-top: 14px;
    }
    
    .res {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      background: var(--card-background);
      position: relative;
    }
    
    .ref {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--primary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .bookmark-btn {
      color: var(--bookmark-color);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .bookmark-btn:hover {
      background: rgba(243, 156, 18, 0.1);
    }

    .bookmark-btn.bookmarked {
      color: var(--bookmark-active);
    }
    
    .text {
      white-space: pre-wrap;
    }
    
    .small {
      font-size: 0.85rem;
      color: #666;
    }
    
    .hidden {
      display: none;
    }
    
    .chapter-text {
      margin-top: 15px;
      line-height: 1.8;
      font-size: 1.15rem;
    }
    
    .verse {
      margin-bottom: 14px;
      padding-bottom: 14px;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }

    [data-theme="dark"] .verse {
      border-bottom-color: #555;
    }
    
    .verse:last-child {
      border-bottom: none;
    }

    .verse:hover .verse-bookmark {
      opacity: 1;
    }

    .verse-bookmark {
      position: absolute;
      right: 8px;
      top: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .verse-num {
      font-size: 0.85em;
      color: var(--secondary-color);
      font-weight: bold;
      margin-right: 6px;
    }
    
    .verse-text {
      display: inline;
      font-weight: 500;
    }
    
    .chapter-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 0 15px;
      color: var(--primary-color);
      text-align: center;
      flex-grow: 1;
    }

    /* –†–µ–∂–∏–º —á—Ç–µ–Ω–∏—è */
    .reading-mode {
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .reading-mode .search-row,
    .reading-mode .nav-row,
    .reading-mode .chapter-nav,
    .reading-mode #navigation > .nav-row,
    .reading-mode #navigation > .chapter-nav,
    .reading-mode #results,
    .reading-mode .bookmarks-panel,
    .reading-mode .note,
    .reading-mode hr {
      display: none !important;
    }

    .reading-mode #navigation {
      display: block !important;
    }

    .reading-mode #chapterDisplay {
      display: block !important;
    }

    .reading-mode .chapter-text {
      font-size: 1.3rem;
      line-height: 2;
      margin-top: 0;
    }

    .reading-mode .verse {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .reading-mode h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 40px;
    }

    .reading-mode-exit {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.2s;
    }

    .reading-mode-exit:hover {
      transform: scale(1.1);
    }
  
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */
.clickable-verse {
  transition: all 0.2s ease;
  border-radius: 8px;
  position: relative;
}

.clickable-verse:hover {
  background-color: var(--hover-color) !important;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.clickable-verse::after {
  content: "üëÜ –ö–ª—ñ–∫–Ω—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É";
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 0.7rem;
  color: var(--secondary-color);
  opacity: 0;
  transition: opacity 0.2s;
}

.clickable-verse:hover::after {
  opacity: 1;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Å—Ç–∏—Ö–∞ */
@keyframes highlightVerse {
  0% {
    background-color: transparent;
    transform: scale(1);
  }
  50% {
    background-color: var(--secondary-color);
    color: white;
    transform: scale(1.02);
  }
  100% {
    background-color: transparent;
    transform: scale(1);
  }
}

.verse.highlighted {
  animation: highlightVerse 2s ease-in-out;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—Ç–∏—Ö–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ */
.ref span:first-child {
  cursor: pointer;
  transition: color 0.2s;
}

.clickable-verse .ref span:first-child:hover {
  text-decoration: underline;
  color: var(--primary-color);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    @media (max-width: 600px) {
      
  .clickable-verse::after {
    font-size: 0.6rem;
    right: 4px;
    top: 4px;
  }

      body {
        padding: 8px;
      }
      
      .nav-row {
        flex-direction: column;
        align-items: stretch;
      }

      h1 {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .controls {
        align-self: stretch;
        justify-content: center;
      }
      
      input[type="search"], select {
        width: 100%;
      }
      
      button {
        width: auto;
      }
      
      .chapter-text {
        font-size: 1.1rem;
        line-height: 1.7;
      }
      
      .verse {
        margin-bottom: 12px;
        padding-bottom: 12px;
      }
      
      button.nav-arrow {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      .reading-mode {
        padding: 20px 15px;
      }

      .reading-mode .chapter-text {
        font-size: 1.2rem;
        line-height: 1.8;
      }
    }
  </style>
</head>
<body>
  <h1>
    <span>–ë—ñ–±–ª—ñ—è ‚Äî –ø–æ—à—É–∫ —Ç–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è</span>
    <div class="controls">
      <button class="icon-btn" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ —Ç–µ–º—É">üåô</button>
      <button class="icon-btn" id="bookmarksToggle" title="–ó–∞–∫–ª–∞–¥–∫–∏">üìö</button>
      <button class="icon-btn" id="readingModeToggle" title="–†–µ–∂–∏–º —á–∏—Ç–∞–Ω–Ω—è">üìñ</button>
    </div>
  </h1>

  <div class="bookmarks-panel" id="bookmarksPanel">
    <div class="bookmarks-header">
      <span>–ó–∞–∫–ª–∞–¥–∫–∏</span>
      <button id="clearBookmarks" style="font-size: 0.8rem; padding: 4px 8px;">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ</button>
    </div>
    <div class="bookmarks-list" id="bookmarksList">
      <div style="text-align: center; color: #666; padding: 20px;">–ù–µ–º–∞—î –∑–∞–∫–ª–∞–¥–æ–∫</div>
    </div>
  </div>

  <div class="note">–¢–µ–∫—Å—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ú–æ–∂–Ω–∞ —à—É–∫–∞—Ç–∏ —Å–ª–æ–≤–∞ –∞–±–æ –æ–±—Ä–∞—Ç–∏ –∫–Ω–∏–≥—É —Ç–∞ –≥–ª–∞–≤—É.</div>

  <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è API -->
  <script src="https://christian-word.github.io/bible-engine/bible-API.js"></script>

  <!-- –ü–æ—à—É–∫ -->
  <div class="search-row">
    <input id="q" type="search" placeholder="–ü–æ—à—É–∫ –ø–æ —Ç–µ–∫—Å—Ç—É..." autocomplete="off" />
    <button id="searchBtn" class="primary">–ó–Ω–∞–π—Ç–∏</button>
  </div>
  <div class="row">
    <button id="backBtn" class="hidden">‚Üê –ù–∞–∑–∞–¥ –¥–æ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó</button>
  </div>
  <div id="status" class="small">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ë—ñ–±–ª—ñ—ó...</div>
  <div id="results" class="hidden"></div>

  <hr>

  <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ –∫–Ω–∏–≥–∞–º -->
  <div id="navigation">
    <div class="nav-row">
      <select id="bookSelect"><option value="">–û–±–µ—Ä—ñ—Ç—å –∫–Ω–∏–≥—É</option></select>
      <select id="chapterSelect"><option value="">–ì–ª–∞–≤–∞</option></select>
    </div>
    
    <div class="chapter-nav hidden" id="chapterNav">
      <button id="prevChapter" class="nav-arrow" title="–ü–æ–ø–µ—Ä–µ–¥–Ω—è –≥–ª–∞–≤–∞">‚Üê</button>
      <div id="currentChapter" class="chapter-title"></div>
      <button id="nextChapter" class="nav-arrow" title="–ù–∞—Å—Ç—É–ø–Ω–∞ –≥–ª–∞–≤–∞">‚Üí</button>
    </div>
    
    <div id="chapterDisplay" class="chapter-text"></div>
  </div>

  <button class="reading-mode-exit hidden" id="readingModeExit">‚úï</button>
 <!-- Viber –∫–Ω–æ–ø–∫–∞ -->
<!-- –ú–∏–Ω–∏-–∫–Ω–æ–ø–∫–∞ Viber -->
<a href="viber://chat?number=%2B380509866724"
   style="display:inline-block;
          padding:8px 14px;
          background:#7360f2;
          color:#fff;
          font-size:14px;
          font-family:Arial,sans-serif;
          border-radius:6px;
          text-decoration:none;
          transition:background 0.3s;">
  üì© –ù–∞–ø–∏—Å–∞—Ç—å –≤ Viber
</a>

 
<!-- –ü–µ—Ä–µ–¥ </body> -->
<div style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid var(--border-color); color: #666; font-size: 0.9rem;">
  ¬© 2025 –ë—ñ–±–ª—ñ—è –æ–Ω–ª–∞–π–Ω, –º. –°—É–º–∏
</div>
  <script>
const qEl = document.getElementById('q');
const searchBtn = document.getElementById('searchBtn');
const backBtn = document.getElementById('backBtn');
const resultsEl = document.getElementById('results');
const statusEl = document.getElementById('status');
const bookSelect = document.getElementById('bookSelect');
const chapterSelect = document.getElementById('chapterSelect');
const chapterDisplay = document.getElementById('chapterDisplay');
const navigationEl = document.getElementById('navigation');
const chapterNav = document.getElementById('chapterNav');
const prevChapterBtn = document.getElementById('prevChapter');
const nextChapterBtn = document.getElementById('nextChapter');
const currentChapterTitle = document.getElementById('currentChapter');

// –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
const themeToggle = document.getElementById('themeToggle');
const bookmarksToggle = document.getElementById('bookmarksToggle');
const readingModeToggle = document.getElementById('readingModeToggle');
const readingModeExit = document.getElementById('readingModeExit');
const bookmarksPanel = document.getElementById('bookmarksPanel');
const bookmarksList = document.getElementById('bookmarksList');
const clearBookmarks = document.getElementById('clearBookmarks');

let currentBook = null;
let currentChapter = null;
let maxChapters = 0;
let bookmarks = [];
let isDarkTheme = false;
let isReadingMode = false;

// –ö–ª—é—á–∏ –¥–ª—è localStorage
const STORAGE_KEYS = {
  BOOKMARKS: 'bible_bookmarks',
  THEME: 'bible_theme',
  READING_MODE: 'bible_reading_mode'
};

function setStatus(t) { statusEl.textContent = t; }

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä BibleAPI –≤—Ä—É—á–Ω—É—é
const bible = new BibleAPIClass();
window.bible = bible; // –î–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º

// === –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ó–ê–ö–õ–ê–î–û–ö ===
function loadBookmarks() {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.BOOKMARKS);
    if (saved) {
      bookmarks = JSON.parse(saved);
    } else {
      bookmarks = [];
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–ª–∞–¥–æ–∫:', e);
    bookmarks = [];
  }
  return bookmarks;
}

function saveBookmarks() {
  try {
    localStorage.setItem(STORAGE_KEYS.BOOKMARKS, JSON.stringify(bookmarks));
    updateBookmarksDisplay();
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–ª–∞–¥–æ–∫:', e);
  }
}

function addBookmark(book, chapter, verse, text) {
  const bookmark = {
    id: Date.now(),
    book: book,
    chapter: parseInt(chapter),
    verse: parseInt(verse),
    text: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
    fullRef: `${book} ${chapter}:${verse}`
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∑–∞–∫–ª–∞–¥–∫–∏
  const exists = bookmarks.find(b => 
    b.book === book && b.chapter === parseInt(chapter) && b.verse === parseInt(verse)
  );
  
  if (!exists) {
    bookmarks.push(bookmark);
    saveBookmarks();
    return true;
  }
  return false;
}

function removeBookmark(book, chapter, verse) {
  bookmarks = bookmarks.filter(b => 
    !(b.book === book && b.chapter === parseInt(chapter) && b.verse === parseInt(verse))
  );
  saveBookmarks();
}

function isBookmarked(book, chapter, verse) {
  return bookmarks.some(b => 
    b.book === book && b.chapter === parseInt(chapter) && b.verse === parseInt(verse)
  );
}

function updateBookmarksDisplay() {
  if (bookmarks.length === 0) {
    bookmarksList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ù–µ–º–∞—î –∑–∞–∫–ª–∞–¥–æ–∫</div>';
    return;
  }

  const html = bookmarks.map(bookmark => `
    <div class="bookmark-item" onclick="navigateToBookmark('${bookmark.book}', ${bookmark.chapter}, ${bookmark.verse})">
      <div>
        <div class="bookmark-ref">${bookmark.fullRef}</div>
        <div class="bookmark-text">${bookmark.text}</div>
      </div>
      <div class="bookmark-delete" onclick="event.stopPropagation(); deleteBookmark(${bookmark.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</div>
    </div>
  `).join('');
  
  bookmarksList.innerHTML = html;
}

function deleteBookmark(id) {
  bookmarks = bookmarks.filter(b => b.id !== id);
  saveBookmarks();
}

function clearAllBookmarks() {
  if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–∞–∫–ª–∞–¥–∫–∏?')) {
    bookmarks = [];
    saveBookmarks();
  }
}

async function navigateToBookmark(book, chapter, verse) {
  // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–º–µ—Ä –∫–Ω–∏–≥–∏
  const books = await bible.getBooks();
  const bookObj = books.find(b => b.name === book);
  if (!bookObj) return;

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
  bookSelect.value = bookObj.number;
  await bookSelect.dispatchEvent(new Event('change'));
  
  setTimeout(() => {
    chapterSelect.value = chapter;
    chapterSelect.dispatchEvent(new Event('change'));
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∑–∞–∫–ª–∞–¥–æ–∫
    bookmarksPanel.classList.remove('show');
    bookmarksToggle.classList.remove('active');
  }, 100);
}

// === –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö –¢–ï–ú–´ ===
function loadTheme() {
  try {
    const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME);
    isDarkTheme = savedTheme === 'dark';
    document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
    themeToggle.textContent = isDarkTheme ? '‚òÄÔ∏è' : 'üåô';
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º—ã:', e);
  }
}

function saveTheme() {
  try {
    localStorage.setItem(STORAGE_KEYS.THEME, isDarkTheme ? 'dark' : 'light');
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã:', e);
  }
}

function toggleTheme() {
  isDarkTheme = !isDarkTheme;
  document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
  themeToggle.textContent = isDarkTheme ? '‚òÄÔ∏è' : 'üåô';
  saveTheme();
}

// === –†–ï–ñ–ò–ú –ß–¢–ï–ù–ò–Ø ===
function toggleReadingMode() {
  isReadingMode = !isReadingMode;
  document.body.classList.toggle('reading-mode', isReadingMode);
  readingModeExit.classList.toggle('hidden', !isReadingMode);
  readingModeToggle.classList.toggle('active', isReadingMode);
  
  if (isReadingMode && !chapterDisplay.innerHTML) {
    setStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥–ª–∞–≤—É –¥–ª—è —Ä–µ–∂–∏–º–∞ —á—Ç–µ–Ω–∏—è');
  }
}

function exitReadingMode() {
  isReadingMode = false;
  document.body.classList.remove('reading-mode');
  readingModeExit.classList.add('hidden');
  readingModeToggle.classList.remove('active');
}

// === –û–ë–ù–û–í–õ–ï–ù–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ì–õ–ê–í ===
async function formatChapterVerses(bookNum, chapterNum) {
  try {
    const verses = await bible.getVerses(bookNum, chapterNum);
    if (!verses || !verses.length) return '<div class="verse">–ì–ª–∞–≤–∞ –ø—É—Å—Ç–∞</div>';
    
    const books = await bible.getBooks();
    const book = books.find(b => b.number === bookNum);
    const bookName = book ? book.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–Ω–∏–≥–∞';
    
    let html = '';
    verses.forEach(verse => {
      const bookmarked = isBookmarked(bookName, chapterNum, verse.number);
      html += `
        <div class="verse">
          <span class="verse-num">${verse.number}</span>
          <span class="verse-text">${verse.text}</span>
          <div class="verse-bookmark bookmark-btn ${bookmarked ? 'bookmarked' : ''}" 
               onclick="toggleVerseBookmark('${bookName}', ${chapterNum}, ${verse.number}, '${verse.text.replace(/'/g, "\\'")}')">
            ${bookmarked ? '‚òÖ' : '‚òÜ'}
          </div>
        </div>
      `;
    });
    return html;
  } catch (e) {
    console.error(e);
    return '<div class="verse">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
  }
}

function toggleVerseBookmark(book, chapter, verse, text) {
  if (isBookmarked(book, chapter, verse)) {
    removeBookmark(book, chapter, verse);
  } else {
    addBookmark(book, chapter, verse, text);
  }
  
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥–ª–∞–≤—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –∑–∞–∫–ª–∞–¥–æ–∫
  showChapter(currentBook, currentChapter);
}

// === –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–•–û–î–ê –ö –°–¢–ò–•–£ ===
async function navigateToVerse(bookName, chapter, verse) {
  try {
    setStatus('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ç–∏—Ö—É...');
    
    // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–º–µ—Ä –∫–Ω–∏–≥–∏
    const books = await bible.getBooks();
    const bookObj = books.find(b => b.name === bookName);
    if (!bookObj) {
      setStatus('–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      return;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
    bookSelect.value = bookObj.number;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–∞–≤—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–∏–≥–∏
    chapterSelect.innerHTML = '<option value="">–ì–ª–∞–≤–∞</option>';
    const chapters = await bible.getChapters(bookObj.number);
    chapters.forEach((ch) => {
      const opt = document.createElement('option');
      opt.value = ch;
      opt.textContent = `–ì–ª–∞–≤–∞ ${ch}`;
      chapterSelect.appendChild(opt);
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–∞–≤—É
    chapterSelect.value = chapter;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–∞–≤—É
    showNavigation();
    await showChapter(bookObj.number, chapter);
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å—Ç–∏—Ö—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
    setTimeout(() => {
      const verseElement = document.querySelector(`.verse:nth-child(${verse})`);
      if (verseElement) {
        verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å—Ç–∏—Ö –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
        verseElement.style.backgroundColor = 'var(--secondary-color)';
        verseElement.style.color = 'white';
        verseElement.style.borderRadius = '8px';
        verseElement.style.padding = '8px';
        verseElement.style.transition = 'all 0.3s';
        
        setTimeout(() => {
          verseElement.style.backgroundColor = '';
          verseElement.style.color = '';
          verseElement.style.borderRadius = '';
          verseElement.style.padding = '';
        }, 2000);
      }
    }, 500);
    
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å—Ç–∏—Ö—É:', e);
    setStatus('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –≤—ñ—Ä—à—É');
  }
}

// === –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê ===
async function showSearchResults() {
  const q = qEl.value.trim();
  resultsEl.innerHTML = '';
  if (!q) { setStatus('–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É.'); return; }
  
  setStatus('–®—É–∫–∞—î–º–æ...');
  try {
    await bible.ready();
    const items = await bible.search(q);
    
    if (!items || !items.length) { 
      setStatus('–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.'); 
      return; 
    }
    
    setStatus(`–ó–Ω–∞–π–¥–µ–Ω–æ ${items.length} –∑–±—ñ–≥—ñ–≤`);
    
    const regex = new RegExp(`(${q})`, 'gi');

    const frag = document.createDocumentFragment();
    for (let it of items) {
      const wrap = document.createElement('div'); 
      wrap.className = 'res clickable-verse';
      wrap.style.cursor = 'pointer';
      wrap.title = '–ö–ª—ñ–∫–Ω—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –≥–ª–∞–≤–∏';
      
      const ref = document.createElement('div'); 
      ref.className = 'ref';
      
      const refText = document.createElement('span');
      refText.textContent = `${it.book} ${it.chapter}:${it.verse}`;
      refText.style.color = 'var(--secondary-color)';
      refText.style.fontWeight = 'bold';
      
      const bookmarkBtn = document.createElement('span');
      bookmarkBtn.className = `bookmark-btn ${isBookmarked(it.book, it.chapter, it.verse) ? 'bookmarked' : ''}`;
      bookmarkBtn.textContent = isBookmarked(it.book, it.chapter, it.verse) ? '‚òÖ' : '‚òÜ';
      bookmarkBtn.onclick = (e) => {
        e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–∫–ª–∞–¥–∫—É
        if (isBookmarked(it.book, it.chapter, it.verse)) {
          removeBookmark(it.book, it.chapter, it.verse);
        } else {
          addBookmark(it.book, it.chapter, it.verse, it.text);
        }
        bookmarkBtn.textContent = isBookmarked(it.book, it.chapter, it.verse) ? '‚òÖ' : '‚òÜ';
        bookmarkBtn.className = `bookmark-btn ${isBookmarked(it.book, it.chapter, it.verse) ? 'bookmarked' : ''}`;
      };
      
      ref.appendChild(refText);
      ref.appendChild(bookmarkBtn);
      
      const txt = document.createElement('div'); 
      txt.className = 'text'; 
      txt.innerHTML = it.text.replace(regex, `<mark style="background-color: yellow;">$1</mark>`);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      wrap.onclick = () => {
        navigateToVerse(it.book, it.chapter, it.verse);
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è
      wrap.addEventListener('mouseenter', () => {
        wrap.style.backgroundColor = 'var(--hover-color)';
      });
      
      wrap.addEventListener('mouseleave', () => {
        wrap.style.backgroundColor = '';
      });
      
      wrap.appendChild(ref); 
      wrap.appendChild(txt);
      frag.appendChild(wrap);
    }
    
    resultsEl.appendChild(frag);
    resultsEl.classList.remove('hidden');
    navigationEl.classList.add('hidden');
    backBtn.classList.remove('hidden');
    qEl.blur();
  } catch (e) {
    console.error(e);
    setStatus('–ü–æ–º–∏–ª–∫–∞: ' + (e?.message || String(e)));
  }
}

function showNavigation() {
  resultsEl.classList.add('hidden');
  navigationEl.classList.remove('hidden');
  backBtn.classList.add('hidden');
  setStatus('–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–∞ —à—É–∫–∞—Ç–∏ –∞–±–æ –æ–±—Ä–∞—Ç–∏ –∫–Ω–∏–≥—É.');
  qEl.value = '';
  qEl.focus();
}

async function updateChapterNavigation() {
  if (!currentBook || !currentChapter) return;
  
  const book = (await bible.getBooks()).find(b => b.number === currentBook);
  currentChapterTitle.textContent = `${book.name} ${currentChapter}`;
  
  prevChapterBtn.disabled = currentChapter <= 1;
  nextChapterBtn.disabled = currentChapter >= maxChapters;
}

async function showChapter(bookNum, chapterNum) {
  if (!bookNum || !chapterNum) {
    chapterDisplay.innerHTML = '';
    chapterNav.classList.add('hidden');
    return;
  }
  
  try {
    setStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–ª–∞–≤–∏...');
    currentBook = bookNum;
    currentChapter = parseInt(chapterNum, 10);
    
    const chapters = await bible.getChapters(bookNum);
    maxChapters = chapters.length;
    
    const versesHtml = await formatChapterVerses(bookNum, chapterNum);
    chapterDisplay.innerHTML = versesHtml;
    
    chapterNav.classList.remove('hidden');
    await updateChapterNavigation();
    
    setStatus(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${currentChapterTitle.textContent}`);
    
    chapterDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (e) {
    console.error(e);
    chapterDisplay.innerHTML = '<div class="verse">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–ª–∞–≤–∏</div>';
    setStatus('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
  }
}

async function navigateToPrevChapter() {
  if (currentChapter > 1) {
    const newChapter = currentChapter - 1;
    chapterSelect.value = newChapter;
    await showChapter(currentBook, newChapter);
  }
}

async function navigateToNextChapter() {
  if (currentChapter < maxChapters) {
    const newChapter = currentChapter + 1;
    chapterSelect.value = newChapter;
    await showChapter(currentBook, newChapter);
  }
}

// === EVENT LISTENERS ===
searchBtn.addEventListener('click', showSearchResults);
backBtn.addEventListener('click', showNavigation);
prevChapterBtn.addEventListener('click', navigateToPrevChapter);
nextChapterBtn.addEventListener('click', navigateToNextChapter);
themeToggle.addEventListener('click', toggleTheme);
readingModeToggle.addEventListener('click', toggleReadingMode);
readingModeExit.addEventListener('click', exitReadingMode);
clearBookmarks.addEventListener('click', clearAllBookmarks);

bookmarksToggle.addEventListener('click', () => {
  bookmarksPanel.classList.toggle('show');
  bookmarksToggle.classList.toggle('active');
  updateBookmarksDisplay();
});

qEl.addEventListener('keydown', e => { 
  if (e.key === 'Enter') showSearchResults(); 
});

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
async function initBooks() {
  try {
    setStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–Ω–∏–≥...');
    await bible.ready();
    setStatus('–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–∞ —à—É–∫–∞—Ç–∏ –∞–±–æ –æ–±—Ä–∞—Ç–∏ –∫–Ω–∏–≥—É.');

    const books = await bible.getBooks();
    bookSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–Ω–∏–≥—É</option>';
    books.forEach((b) => {
      const opt = document.createElement('option');
      opt.value = b.number;
      opt.textContent = b.name;
      bookSelect.appendChild(opt);
    });
  } catch (err) {
    console.error(err);
    setStatus('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏: ' + (err?.message || String(err)));
  }
}

bookSelect.addEventListener('change', async () => {
  chapterSelect.innerHTML = '<option value="">–ì–ª–∞–≤–∞</option>';
  chapterDisplay.innerHTML = '';
  chapterNav.classList.add('hidden');
  
  const bookNum = bookSelect.value;
  if (!bookNum) return;
  
  try {
    setStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –≥–ª–∞–≤...');
    const chapters = await bible.getChapters(bookNum);
    chapters.forEach((ch) => {
      const opt = document.createElement('option');
      opt.value = ch;
      opt.textContent = `–ì–ª–∞–≤–∞ ${ch}`;
      chapterSelect.appendChild(opt);
    });
    setStatus('–û–±–µ—Ä—ñ—Ç—å –≥–ª–∞–≤—É');
  } catch (e) {
    console.error(e);
    setStatus('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–ª–∞–≤');
  }
});

chapterSelect.addEventListener('change', async () => {
  await showChapter(bookSelect.value, chapterSelect.value);
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick –≤ HTML
window.toggleVerseBookmark = toggleVerseBookmark;
window.navigateToBookmark = navigateToBookmark;
window.deleteBookmark = deleteBookmark;
window.navigateToVerse = navigateToVerse;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  loadBookmarks();
  loadTheme();
  
  initBooks();
  updateBookmarksDisplay();
  
  // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  setTimeout(() => qEl.focus(), 300);
});

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + D –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
  if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
    e.preventDefault();
    toggleTheme();
  }
  
  // Ctrl/Cmd + R –¥–ª—è —Ä–µ–∂–∏–º–∞ —á—Ç–µ–Ω–∏—è
  if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
    e.preventDefault();
    toggleReadingMode();
  }
  
  // Ctrl/Cmd + B –¥–ª—è –∑–∞–∫–ª–∞–¥–æ–∫
  if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
    e.preventDefault();
    bookmarksPanel.classList.toggle('show');
    bookmarksToggle.classList.toggle('active');
    updateBookmarksDisplay();
  }
  
  // Escape –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ä–µ–∂–∏–º–∞ —á—Ç–µ–Ω–∏—è
  if (e.key === 'Escape' && isReadingMode) {
    exitReadingMode();
  }
  
  // –°—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –≥–ª–∞–≤–∞–º –≤ —Ä–µ–∂–∏–º–µ —á—Ç–µ–Ω–∏—è
  if (isReadingMode) {
    if (e.key === 'ArrowLeft' && !prevChapterBtn.disabled) {
      navigateToPrevChapter();
    }
    if (e.key === 'ArrowRight' && !nextChapterBtn.disabled) {
      navigateToNextChapter();
    }
  }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∑–∞–∫–ª–∞–¥–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë
bookmarksPanel.addEventListener('click', (e) => {
  e.stopPropagation();
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –∑–∞–∫–ª–∞–¥–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
document.addEventListener('click', (e) => {
  if (!bookmarksToggle.contains(e.target) && !bookmarksPanel.contains(e.target)) {
    bookmarksPanel.classList.remove('show');
    bookmarksToggle.classList.remove('active');
  }
});
    </script>
</body>
</html>



